/*
Pointer optimization:
Before - 8706 instructions
Mild pointer optimizations - use of offset(base, scale): 7483

*/

asm{
	#include "CPU.asm"
	entry code
	data@ data
code:
	push $4664
	;call mm_init
	;call doublePointer
	;push $4660
	call test
	hlt
};

fun print(var n){
	asm{
		out %r1
	};
}


fun fibonacci(var *start, var num){
	var *end = start + num;
	var *cur = start;	
	*cur = 0;
	*(cur + 1) = 1;
	cur = cur + 2;
	while(cur < end){
		*cur = *(cur - 1) + *(cur - 2);
		cur = cur + 1;
	}
	return *(start + num - 1);
}


fun test(){
	var i = 1;
	while(i < 20)
	{
		var result = fibonacci(512, i);
		print(result);
		i = i + 1;
	}
}
$$
